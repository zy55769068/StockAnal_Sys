{% extends "layout.html" %}

{% block title %}è‚¡ç¥¨è¯¦æƒ… - {{ stock_code }} - æ™ºèƒ½åˆ†æç³»ç»Ÿ{% endblock %}

{% block head %}
<style>
    /* è‡ªå®šä¹‰æ ·å¼ */
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: none;
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        background-color: #fff;
        font-weight: 600;
        border-radius: 10px 10px 0 0 !important;
    }
    .price-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4eafd 100%);
    }
    .stock-price {
        font-size: 1.8rem;
        font-weight: 700;
    }
    .score-pill {
        font-size: 1.1rem;
        padding: 0.4rem 0.8rem;
        border-radius: 30px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .indicator-value {
        font-weight: 600;
    }
    .analysis-section {
        line-height: 1.8;
    }
    .support-resistance-table td, .support-resistance-table th {
        padding: 0.5rem;
    }
    .trend-up {
        background: linear-gradient(90deg, rgba(40,167,69,0.1) 0%, rgba(255,255,255,0) 100%);
        border-left: 3px solid #28a745;
        padding-left: 8px;
    }
    .trend-down {
        background: linear-gradient(90deg, rgba(220,53,69,0.1) 0%, rgba(255,255,255,0) 100%);
        border-left: 3px solid #dc3545;
        padding-left: 8px;
    }
    .chart-card {
        overflow: hidden;
    }
    .tab-content {
        padding: 1rem;
    }
    .nav-tabs .nav-link {
        border: none;
        color: #495057;
        font-weight: 500;
        padding: 0.75rem 1rem;
    }
    .nav-tabs .nav-link.active {
        color: #4e73df;
        background-color: transparent;
        border-bottom: 3px solid #4e73df;
    }
    .ai-analysis-container {
        position: relative;
        min-height: 200px;
    }
    .ai-analysis-content {
        transition: opacity 0.3s ease;
    }
    .ai-analysis-loader {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(255,255,255,0.8);
        z-index: 10;
    }
    .typing-indicator {
        display: inline-block;
        margin-top: 10px;
    }
    .typing-indicator span {
        height: 10px;
        width: 10px;
        float: left;
        margin: 0 2px;
        background-color: #4e73df;
        border-radius: 50%;
        opacity: 0.4;
        animation: typing 1s infinite;
    }
    .typing-indicator span:nth-of-type(1) { animation-delay: 0s; }
    .typing-indicator span:nth-of-type(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-of-type(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0% { transform: scale(1); }
        50% { transform: scale(1.5); opacity: 0.8; }
        100% { transform: scale(1); }
    }
    .badge-pill {
        border-radius: 30px;
        padding: 0.4em 0.8em;
    }
    .market-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    .price-change-up {
        background-color: rgba(40,167,69,0.1);
        color: #28a745;
    }
    .price-change-down {
        background-color: rgba(220,53,69,0.1);
        color: #dc3545;
    }
    .progress {
        height: 5px;
        margin-top: 5px;
    }
    .analysis-para {
        margin-bottom: 1rem;
    }
    .score-indicator {
        position: relative;
        height: 180px;
        width: 180px;
        margin: 0 auto;
    }
    .score-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    .score-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    .score-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    .quick-stat {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    .quick-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div id="alerts-container"></div>

    <!-- æ ‡é¢˜å’Œæ§åˆ¶åŒº -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 id="stock-title" class="mb-0 fw-bold">
                <span class="shimmer-bg" style="width: 200px; height: 24px;"></span>
            </h4>
            <p id="stock-info" class="text-muted mb-0 small">
                <span class="shimmer-bg" style="width: 150px; height: 16px;"></span>
            </p>
        </div>
        <div class="d-flex align-items-center">
            <select class="form-select form-select-sm me-2" id="market-type" style="max-width: 100px;">
                <option value="A" {% if market_type == 'A' %}selected{% endif %}>Aè‚¡</option>
                <option value="HK" {% if market_type == 'HK' %}selected{% endif %}>æ¸¯è‚¡</option>
                <option value="US" {% if market_type == 'US' %}selected{% endif %}>ç¾è‚¡</option>
            </select>
            <select class="form-select form-select-sm me-2" id="analysis-period" style="max-width: 100px;">
                <option value="1m">1ä¸ªæœˆ</option>
                <option value="3m">3ä¸ªæœˆ</option>
                <option value="6m">6ä¸ªæœˆ</option>
                <option value="1y" selected>1å¹´</option>
            </select>
            <button id="refresh-btn" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- ç³»ç»ŸæŒ‡æ ‡åŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤ºï¼Œä½†å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€ -->
    <div id="system-indicators">
        <!-- ç¬¬ä¸€è¡Œï¼šè‚¡ç¥¨æ¦‚è¦å’Œè¯„åˆ† -->
        <div class="row g-3 mb-3">
            <!-- è‚¡ç¥¨æ¦‚è¦å¡ç‰‡ -->
            <div class="col-md-4">
                <div class="card price-card h-100">
                    <div class="card-body position-relative">
                        <span id="market-badge" class="badge market-badge"></span>
                        <div class="row align-items-center">
                            <div class="col-7">
                                <div id="price-container">
                                    <div class="shimmer-bg" style="width: 120px; height: 32px;"></div>
                                    <div class="shimmer-bg mt-1" style="width: 80px; height: 20px;"></div>
                                </div>
                            </div>
                            <div class="col-5 text-end">
                                <div id="recommendation-container">
                                    <div class="shimmer-bg" style="width: 100px; height: 24px;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>ä»Šå¼€ï¼š<span id="open-price">--</span></span>
                                    <span>æœ€é«˜ï¼š<span id="high-price">--</span></span>
                                    <span>æœ€ä½ï¼š<span id="low-price">--</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯„åˆ†å¡ç‰‡ -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">ç»¼åˆè¯„åˆ†</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="score-container" class="d-flex align-items-center justify-content-center">
                            <div class="shimmer-bg rounded-circle" style="width: 120px; height: 120px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æŠ€æœ¯æŒ‡æ ‡å¡ç‰‡ -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">å…³é”®æŒ‡æ ‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="quick-stat">
                                    <div id="rsi-container">
                                        <div class="shimmer-bg mx-auto" style="width: 50px; height: 24px;"></div>
                                        <div class="shimmer-bg mx-auto mt-1" style="width: 40px; height: 16px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="quick-stat">
                                    <div id="ma-trend-container">
                                        <div class="shimmer-bg mx-auto" style="width: 50px; height: 24px;"></div>
                                        <div class="shimmer-bg mx-auto mt-1" style="width: 40px; height: 16px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="quick-stat">
                                    <div id="macd-container">
                                        <div class="shimmer-bg mx-auto" style="width: 50px; height: 24px;"></div>
                                        <div class="shimmer-bg mx-auto mt-1" style="width: 40px; height: 16px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="quick-stat">
                                    <div id="volume-container">
                                        <div class="shimmer-bg mx-auto" style="width: 50px; height: 24px;"></div>
                                        <div class="shimmer-bg mx-auto mt-1" style="width: 40px; height: 16px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šå›¾è¡¨åŒºåŸŸ -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card chart-card">
                    <div class="card-header py-2">
                        <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="price-tab" data-bs-toggle="tab" data-bs-target="#price-content" type="button" role="tab" aria-controls="price-content" aria-selected="true">ä»·æ ¼è¶‹åŠ¿</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="indicators-tab" data-bs-toggle="tab" data-bs-target="#indicators-content" type="button" role="tab" aria-controls="indicators-content" aria-selected="false">æŠ€æœ¯æŒ‡æ ‡</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="volume-tab" data-bs-toggle="tab" data-bs-target="#volume-content" type="button" role="tab" aria-controls="volume-content" aria-selected="false">æˆäº¤é‡</button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content" id="chartTabsContent">
                        <div class="tab-pane fade show active" id="price-content" role="tabpanel" aria-labelledby="price-tab">
                            <div id="price-chart" style="height: 400px;"></div>
                        </div>
                        <div class="tab-pane fade" id="indicators-content" role="tabpanel" aria-labelledby="indicators-tab">
                            <div id="indicators-chart" style="height: 400px;"></div>
                        </div>
                        <div class="tab-pane fade" id="volume-content" role="tabpanel" aria-labelledby="volume-tab">
                            <div id="volume-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šæ”¯æ’‘å‹åŠ›ä½å’Œé›·è¾¾å›¾ -->
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">æ”¯æ’‘ä¸å‹åŠ›ä½</h5>
                    </div>
                    <div class="card-body">
                        <div id="support-resistance-container">
                            <div class="shimmer-bg" style="width: 100%; height: 120px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h5 class="mb-0">å¤šç»´åº¦è¯„åˆ†</h5>
                    </div>
                    <div class="card-body">
                        <div id="radar-chart-container">
                            <div class="shimmer-bg" style="width: 100%; height: 200px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AIåˆ†æåŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤ºï¼Œä½†å¼‚æ­¥åŠ è½½å†…å®¹ -->
    <div class="row g-3 mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AIåˆ†ææŠ¥å‘Š</h5>
                    <div>
                        <span id="ai-analysis-status" class="badge bg-info">å‡†å¤‡åˆ†æ...</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="ai-analysis-container">
                        <!-- AIåˆ†æåŠ è½½åŠ¨ç”» -->
                        <div id="ai-analysis-loader" class="ai-analysis-loader">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">æ­£åœ¨åˆ†æ...</span>
                            </div>
                            <p class="mt-3 mb-0">æ­£åœ¨å¯¹ <span id="ai-analysis-stock-name">è¯¥è‚¡ç¥¨</span> è¿›è¡Œæ™ºèƒ½åˆ†æ</p>
                            <p class="text-muted small mt-1">
                                å·²ç”¨æ—¶ <span id="ai-processing-time">0</span> ç§’
                            </p>
                            <div class="typing-indicator mt-2">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <div class="progress mt-3" style="width: 250px;">
                                <div id="ai-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <button id="cancel-analysis-btn" class="btn btn-outline-secondary btn-sm mt-3">
                                <i class="fas fa-times"></i> å–æ¶ˆåˆ†æ
                            </button>
                        </div>
                        
                        <!-- AIåˆ†æå†…å®¹ -->
                        <div id="ai-analysis-content" class="ai-analysis-content" style="opacity: 0;">
                            <div id="ai-analysis" class="analysis-section">
                                <!-- AIåˆ†æå†…å®¹å°†å¼‚æ­¥å¡«å…… -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½é”™è¯¯æ—¶æ˜¾ç¤ºçš„é‡è¯•æŒ‰é’® -->
    <div id="error-retry" class="text-center mt-3" style="display: none;">
        <div class="alert alert-warning">
            <p><i class="fas fa-exclamation-triangle"></i> åˆ†æè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯</p>
            <button id="retry-button" class="btn btn-primary mt-2">
                <i class="fas fa-sync-alt"></i> é‡è¯•åˆ†æ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const stockCode = '{{ stock_code }}';
    let marketType = '{{ market_type }}';
    let period = '1y';
    let stockData = [];
    let analysisResult = null;
    let processingTimer;
    let processingTime = 0;
    
    // é¡µé¢åŠ è½½æ—¶çš„é—ªçƒæ•ˆæœ
    function addShimmerEffect() {
        let style = document.createElement('style');
        style.innerHTML = `
            .shimmer-bg {
                background: #f6f7f8;
                background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
                background-repeat: no-repeat;
                background-size: 800px 104px;
                display: inline-block;
                position: relative;
                animation-duration: 1.5s;
                animation-fill-mode: forwards;
                animation-iteration-count: infinite;
                animation-name: shimmer;
                animation-timing-function: linear;
                border-radius: 4px;
            }
            @keyframes shimmer {
                0% { background-position: -468px 0 }
                100% { background-position: 468px 0 }
            }
        `;
        document.head.appendChild(style);
    }

    $(document).ready(function() {
        addShimmerEffect();
        
        // åˆå§‹åŠ è½½
        loadStockData();

        // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#refresh-btn').click(function() {
            marketType = $('#market-type').val();
            period = $('#analysis-period').val();
            loadStockData();
        });

        // å¸‚åœºç±»å‹æ”¹å˜äº‹ä»¶
        $('#market-type').change(function() {
            marketType = $(this).val();
        });

        // åˆ†æå‘¨æœŸæ”¹å˜äº‹ä»¶
        $('#analysis-period').change(function() {
            period = $(this).val();
        });
        
        // å–æ¶ˆåˆ†ææŒ‰é’®
        $('#cancel-analysis-btn').click(function() {
            cancelAnalysis();
        });
        
        // é‡è¯•æŒ‰é’®
        $('#retry-button').click(function() {
            $('#error-retry').hide();
            startAIAnalysis();
        });
    });

    // åŠ è½½è‚¡ç¥¨æ•°æ®
    function loadStockData() {
        resetUI();
        showSystemLoadingState();
        
        // è·å–è‚¡ç¥¨æ•°æ®
        $.ajax({
            url: `/api/stock_data?stock_code=${stockCode}&market_type=${marketType}&period=${period}`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (!response.data || response.data.length === 0) {
                    hideSystemLoadingState();
                    showError('æœªæ‰¾åˆ°è‚¡ç¥¨æ•°æ®');
                    return;
                }

                stockData = response.data;
                
                // æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡éƒ¨åˆ†
                renderSystemIndicators();
                
                // ç³»ç»ŸæŒ‡æ ‡åŠ è½½å®Œæˆåï¼Œå¼‚æ­¥å¯åŠ¨AIåˆ†æ
                startAIAnalysis();
            },
            error: function(xhr, status, error) {
                hideSystemLoadingState();
                
                let errorMsg = 'è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (error) {
                    errorMsg += ': ' + error;
                }
                showError(errorMsg);
            }
        });
    }
    
    // é‡ç½®UIçŠ¶æ€
    function resetUI() {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        processingTime = 0;
        
        // éšè—é”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').hide();
        
        // é‡ç½®AIåˆ†æåŒºåŸŸ
        $('#ai-analysis-status').text('å‡†å¤‡åˆ†æ...').removeClass('bg-success bg-danger').addClass('bg-info');
        $('#ai-analysis-content').css('opacity', '0');
        $('#ai-analysis-loader').show();
        $('#ai-progress-bar').css('width', '0%');
        $('#ai-processing-time').text('0');
    }
    
    // æ˜¾ç¤ºç³»ç»ŸæŒ‡æ ‡åŠ è½½çŠ¶æ€
    function showSystemLoadingState() {
        // å·²é€šè¿‡é—ªçƒæ•ˆæœå±•ç¤º
    }
    
    // éšè—ç³»ç»ŸæŒ‡æ ‡åŠ è½½çŠ¶æ€
    function hideSystemLoadingState() {
        // é—ªçƒæ•ˆæœä¼šåœ¨æ¸²æŸ“å®é™…å†…å®¹æ—¶è¢«æ›¿æ¢
    }
    
    // æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡éƒ¨åˆ†
    function renderSystemIndicators() {
        try {
            if (!stockData || stockData.length === 0) {
                showError("æ— å¯ç”¨æ•°æ®");
                return;
            }
            
            const latestData = stockData[stockData.length - 1];
            const prevData = stockData.length > 1 ? stockData[stockData.length - 2] : latestData;
            
            // è®¾ç½®æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯
            updateStockInfo(latestData);
            
            // æ¸²æŸ“ä»·æ ¼å›¾è¡¨
            renderPriceChart();
            
            // æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨
            renderIndicatorsChart();
            
            // æ¸²æŸ“æˆäº¤é‡å›¾è¡¨
            renderVolumeChart();
            
            // è·å–æˆ–è®¡ç®—æ”¯æ’‘å‹åŠ›ä½
            calculateAndRenderSupportResistance(latestData);
            
            // è®¡ç®—å¹¶æ¸²æŸ“æŠ€æœ¯è¯„åˆ†
            calculateAndRenderScore(latestData);
            
            // éšè—åŠ è½½çŠ¶æ€
            hideSystemLoadingState();
        } catch (error) {
            console.error("æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡æ—¶å‡ºé”™:", error);
            showError("æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡æ—¶å‡ºé”™: " + error.message);
        }
    }

    // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
    function safeGet(obj, path, defaultValue) {
        if (!obj) return defaultValue;
        
        const props = path.split('.');
        let current = obj;
        
        for (let i = 0; i < props.length; i++) {
            if (current === undefined || current === null) {
                console.warn(`å±æ€§è·¯å¾„ ${path} åœ¨ ${props.slice(0, i).join('.')} å¤„ä¸­æ–­`);
                return defaultValue;
            }
            current = current[props[i]];
        }
        
        return current !== undefined && current !== null ? current : defaultValue;
    }
    
    // æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
    function updateStockInfo(latestData) {

        console.info('æ•°æ®é›†ğŸ“š:', latestData);

        // è·å–æœ€æ–°ä»·æ ¼å’Œæ¶¨è·Œ
        const currentPrice = parseFloat(latestData.close);
        const previousPrice = stockData.length > 1 ? parseFloat(stockData[stockData.length - 2].close) : currentPrice;
        const priceChange = currentPrice - previousPrice;
        const priceChangePercent = (priceChange / previousPrice) * 100;
        
        // åˆå§‹è®¾ç½®å ä½å€¼ï¼Œç­‰å¾…AIåˆ†æç»“æœ
        let stockName = "åŠ è½½ä¸­...";
        let industry = "è¡Œä¸šæ•°æ®åŠ è½½ä¸­...";
    
        // è®¾ç½®é¡µé¢ä¸­çš„è‚¡ç¥¨ä»£ç å’Œé»˜è®¤å€¼
        $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
        $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${new Date(latestData.date).toLocaleDateString()}`);
    
        
        // æ›´æ–°è‚¡ç¥¨æ ‡é¢˜
        // const stockName = latestData.stockName || "æœªçŸ¥";
        // $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
        
        // æ ¹æ®å¸‚åœºç±»å‹æ˜¾ç¤ºä¸åŒæ ‡ç­¾
        let marketBadge = '';
        if (marketType === 'A') {
            marketBadge = '<span class="badge bg-primary">Aè‚¡</span>';
        } else if (marketType === 'HK') {
            marketBadge = '<span class="badge bg-success">æ¸¯è‚¡</span>';
        } else if (marketType === 'US') {
            marketBadge = '<span class="badge bg-info">ç¾è‚¡</span>';
        }
        $('#market-badge').html(marketBadge);
        
        // æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
        // const industry = latestData.industry || "æœªçŸ¥è¡Œä¸š";
        const date = new Date(latestData.date).toLocaleDateString();
        // $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${date}`);
        
        // æ›´æ–°ä»·æ ¼
        const priceChangeClass = priceChange >= 0 ? 'trend-up' : 'trend-down';
        const priceChangeIcon = priceChange >= 0 ? '<i class="fas fa-caret-up"></i>' : '<i class="fas fa-caret-down"></i>';
        const priceChangeDisplay = `${priceChangeIcon} ${Math.abs(priceChange).toFixed(2)} (${Math.abs(priceChangePercent).toFixed(2)}%)`;
        
        $('#price-container').html(`
            <div class="stock-price ${priceChangeClass}">${currentPrice.toFixed(2)}</div>
            <div class="price-change ${priceChangeClass}">${priceChangeDisplay}</div>
        `);
        
        // æ›´æ–°å¼€ç›˜ã€æœ€é«˜ã€æœ€ä½ä»·æ ¼
        $('#open-price').text(latestData.open ? parseFloat(latestData.open).toFixed(2) : '--');
        $('#high-price').text(latestData.high ? parseFloat(latestData.high).toFixed(2) : '--');
        $('#low-price').text(latestData.low ? parseFloat(latestData.low).toFixed(2) : '--');
        
        // æ›´æ–°AIåˆ†æè‚¡ç¥¨åç§°
        $('#ai-analysis-stock-name').text(stockName);
    }
    
    // è®¡ç®—æŠ€æœ¯è¯„åˆ†å¹¶æ¸²æŸ“
    function calculateAndRenderScore(latestData) {
        // ç¤ºä¾‹æŠ€æœ¯è¯„åˆ†è®¡ç®— (ç®€åŒ–ç‰ˆ)
        let score = 0;
        
        // RSIè¯„åˆ† (0-25)
        const rsi = parseFloat(latestData.RSI || 50);
        if (rsi >= 40 && rsi <= 60) score += 20;
        else if ((rsi >= 30 && rsi < 40) || (rsi > 60 && rsi <= 70)) score += 15;
        else if (rsi < 30) score += 10;
        else if (rsi > 70) score += 5;
        
        // å‡çº¿è¶‹åŠ¿è¯„åˆ† (0-25)
        const ma5 = parseFloat(latestData.MA5 || 0);
        const ma20 = parseFloat(latestData.MA20 || 0);
        const ma60 = parseFloat(latestData.MA60 || 0);
        if (ma5 > ma20 && ma20 > ma60) score += 25;
        else if (ma5 > ma20) score += 15;
        else if (ma20 > ma60) score += 10;
        else score += 0;
        
        // MACDè¯„åˆ† (0-25)
        const macd = parseFloat(latestData.MACD || 0);
        const signal = parseFloat(latestData.Signal || 0);
        if (macd > signal && macd > 0) score += 25;
        else if (macd > signal) score += 15;
        else if (macd > 0) score += 10;
        else score += 0;
        
        // æˆäº¤é‡è¯„åˆ† (0-25)
        const volRatio = parseFloat(latestData.Volume_Ratio || 1);
        if (volRatio > 1.5 && ma5 > ma20) score += 25;
        else if (volRatio > 1) score += 15;
        else if (volRatio > 0.8) score += 10;
        else score += 0;
        
        // æ¸²æŸ“è¯„åˆ†
        const scoreClass = getScoreColorClass(score);
        const scoreText = getScoreDescription(score);
        
        $('#score-container').html(`
            <div class="score-indicator">
                <div id="score-chart"></div>
                <div class="score-display">
                    <p class="score-value">${score}</p>
                    <p class="score-label">ç»¼åˆè¯„åˆ†</p>
                </div>
            </div>
        `);
        
        // æ¸²æŸ“ç¯å½¢å›¾è¡¨
        renderScoreChart(score);
        
        // æ¸²æŸ“å»ºè®®
        $('#recommendation-container').html(`
            <div class="badge badge-pill ${scoreClass} px-3 py-2">${scoreText}</div>
        `);
        
        // æ¸²æŸ“å…³é”®æŒ‡æ ‡
        $('#rsi-container').html(`
            <div class="stat-value">${rsi.toFixed(1)}</div>
            <div class="stat-label">RSI</div>
        `);
        
        const maTrend = ma5 > ma20 ? 'trend-up' : 'trend-down';
        const maTrendIcon = ma5 > ma20 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
        const maTrendText = ma5 > ma20 ? 'å¤šå¤´æ’åˆ—' : 'ç©ºå¤´æ’åˆ—';
        
        $('#ma-trend-container').html(`
            <div class="stat-value ${maTrend}">${maTrendIcon}</div>
            <div class="stat-label">å‡çº¿è¶‹åŠ¿</div>
        `);
        
        const macdTrend = macd > signal ? 'trend-up' : 'trend-down';
        const macdTrendIcon = macd > signal ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
        
        $('#macd-container').html(`
            <div class="stat-value ${macdTrend}">${macdTrendIcon}</div>
            <div class="stat-label">MACD</div>
        `);
        
        const volumeStatus = volRatio > 1 ? 'trend-up' : 'trend-down';
        const volumeIcon = volRatio > 1 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
        
        $('#volume-container').html(`
            <div class="stat-value ${volumeStatus}">${volRatio.toFixed(1)}</div>
            <div class="stat-label">é‡æ¯”</div>
        `);
        
        // æ¸²æŸ“é›·è¾¾å›¾
        renderRadarChart(rsi/10, (ma5 > ma20 ? 8 : 3), (macd > signal ? 8 : 3), (volRatio > 1 ? 8 : 3));
    }
    
    // è®¡ç®—å¹¶æ¸²æŸ“æ”¯æ’‘å‹åŠ›ä½
    function calculateAndRenderSupportResistance(latestData) {
        const currentPrice = parseFloat(latestData.close);
        
        // å¸ƒæ—å¸¦æ”¯æ’‘å‹åŠ›
        const upperBand = parseFloat(latestData.BB_upper || (currentPrice * 1.05));
        const lowerBand = parseFloat(latestData.BB_lower || (currentPrice * 0.95));
        
        // ç§»åŠ¨å¹³å‡çº¿æ”¯æ’‘å‹åŠ›
        const ma5 = parseFloat(latestData.MA5 || 0);
        const ma20 = parseFloat(latestData.MA20 || 0);
        const ma60 = parseFloat(latestData.MA60 || 0);
        
        // è®¡ç®—æ”¯æ’‘ä½
        const supports = [];
        const resistances = [];
        
        // å¦‚æœä»·æ ¼åœ¨å‡çº¿ä¸Šæ–¹ï¼Œå°†å‡çº¿ä½œä¸ºæ”¯æ’‘ä½
        if (currentPrice > ma5) supports.push({level: ma5, type: 'MA5', distance: ((ma5 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma5, type: 'MA5', distance: ((ma5 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        if (currentPrice > ma20) supports.push({level: ma20, type: 'MA20', distance: ((ma20 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma20, type: 'MA20', distance: ((ma20 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        if (currentPrice > ma60) supports.push({level: ma60, type: 'MA60', distance: ((ma60 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma60, type: 'MA60', distance: ((ma60 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        // å¸ƒæ—å¸¦æ”¯æ’‘å‹åŠ›
        supports.push({level: lowerBand, type: 'å¸ƒæ—ä¸‹è½¨', distance: ((lowerBand - currentPrice) / currentPrice * 100).toFixed(2)});
        resistances.push({level: upperBand, type: 'å¸ƒæ—ä¸Šè½¨', distance: ((upperBand - currentPrice) / currentPrice * 100).toFixed(2)});
        
        // æ·»åŠ æ•´æ•°å…³å£
        const integerSupport = Math.floor(currentPrice);
        const integerResistance = Math.ceil(currentPrice);
        
        if (integerSupport < currentPrice) {
            supports.push({level: integerSupport, type: 'æ•´æ•°å…³å£', distance: ((integerSupport - currentPrice) / currentPrice * 100).toFixed(2)});
        }
        
        if (integerResistance > currentPrice) {
            resistances.push({level: integerResistance, type: 'æ•´æ•°å…³å£', distance: ((integerResistance - currentPrice) / currentPrice * 100).toFixed(2)});
        }
        
        // æŒ‰è·ç¦»æ’åº
        supports.sort((a, b) => parseFloat(b.distance) - parseFloat(a.distance));
        resistances.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
        
        // æ¸²æŸ“è¡¨æ ¼
        let tableHtml = `
            <table class="table table-sm support-resistance-table">
                <thead>
                    <tr>
                        <th>ç±»å‹</th>
                        <th>ä»·æ ¼</th>
                        <th>è·ç¦»</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // æ·»åŠ å‹åŠ›ä½
        resistances.slice(0, 3).forEach(r => {
            tableHtml += `
                <tr>
                    <td><span class="badge bg-danger">å‹åŠ›</span> ${r.type}</td>
                    <td>${r.level.toFixed(2)}</td>
                    <td>+${Math.abs(r.distance)}%</td>
                </tr>
            `;
        });
        
        // æ·»åŠ å½“å‰ä»·æ ¼
        tableHtml += `
            <tr class="table-info">
                <td><span class="badge bg-primary">å½“å‰</span></td>
                <td>${currentPrice.toFixed(2)}</td>
                <td>-</td>
            </tr>
        `;
        
        // æ·»åŠ æ”¯æ’‘ä½
        supports.slice(0, 3).forEach(s => {
            tableHtml += `
                <tr>
                    <td><span class="badge bg-success">æ”¯æ’‘</span> ${s.type}</td>
                    <td>${s.level.toFixed(2)}</td>
                    <td>${s.distance}%</td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        $('#support-resistance-container').html(tableHtml);
    }
    
    // æ¸²æŸ“è¯„åˆ†å›¾è¡¨
    function renderScoreChart(score) {
        const options = {
            series: [score],
            chart: {
                height: 180,
                type: 'radialBar',
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                radialBar: {
                    startAngle: -135,
                    endAngle: 135,
                    hollow: {
                        margin: 0,
                        size: '70%',
                    },
                    dataLabels: {
                        show: false
                    },
                    track: {
                        background: '#f2f2f2',
                        strokeWidth: '97%',
                        margin: 5,
                        dropShadow: {
                            enabled: false
                        }
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.5,
                    gradientToColors: [getScoreGradientColor(score)],
                    inverseColors: true,
                    opacityFrom: 1,
                    opacityTo: 1,
                    stops: [0, 100]
                }
            },
            stroke: {
                lineCap: 'round'
            },
            colors: [getScoreColor(score)]
        };

        const chart = new ApexCharts(document.querySelector("#score-chart"), options);
        chart.render();
    }
    
    // æ¸²æŸ“é›·è¾¾å›¾
    function renderRadarChart(rsiScore, trendScore, macdScore, volumeScore) {
        $('#radar-chart-container').html('<div id="radar-chart" style="height: 200px;"></div>');
        
        const options = {
            series: [{
                name: 'è¯„åˆ†',
                data: [rsiScore, trendScore, macdScore, volumeScore]
            }],
            chart: {
                height: 200,
                type: 'radar',
                toolbar: {
                    show: false
                },
                dropShadow: {
                    enabled: true,
                    blur: 1,
                    left: 1,
                    top: 1
                }
            },
            stroke: {
                width: 2
            },
            fill: {
                opacity: 0.2
            },
            markers: {
                size: 3
            },
            xaxis: {
                categories: ['RSI', 'è¶‹åŠ¿', 'MACD', 'æˆäº¤é‡']
            },
            yaxis: {
                show: false,
                min: 0,
                max: 10
            },
            plotOptions: {
                radar: {
                    polygons: {
                        strokeColors: '#e9e9e9',
                        fill: {
                            colors: ['#f8f8f8', '#fff']
                        }
                    }
                }
            }
        };

        const chart = new ApexCharts(document.querySelector("#radar-chart"), options);
        chart.render();
    }
    
    // æ¸²æŸ“ä»·æ ¼å›¾è¡¨
    function renderPriceChart() {
        $('#price-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const closePrices = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.close || 0)
            }));
            
            const ma5Data = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.MA5 || null)
            }));
            
            const ma20Data = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.MA20 || null)
            }));
            
            const ma60Data = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.MA60 || null)
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: closePrices
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma5Data
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma20Data
                    },
                    {
                        name: 'MA60',
                        type: 'line',
                        data: ma60Data
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    }
                },
                stroke: {
                    width: [3, 2, 2, 2],
                    curve: 'smooth',
                    dashArray: [0, 0, 0, 0]
                },
                colors: ['#4e73df', '#36b9cc', '#1cc88a', '#f6c23e'],
                fill: {
                    type: 'solid',
                    opacity: [1, 0.8, 0.8, 0.8],
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (value) {
                            return value.toFixed(2);
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value) {
                            return value ? value.toFixed(2) : '-';
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                },
                grid: {
                    borderColor: '#e0e0e0',
                    strokeDashArray: 5,
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#price-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“ä»·æ ¼å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#price-chart').html('<div class="alert alert-danger">ä»·æ ¼å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
    function renderIndicatorsChart() {
        $('#indicators-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const macdData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.MACD || 0)
            }));
            
            const signalData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.Signal || 0)
            }));
            
            const histogramData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.MACD_hist || 0)
            }));
            
            const rsiData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.RSI || 0)
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'MACD',
                        type: 'line',
                        data: macdData
                    },
                    {
                        name: 'Signal',
                        type: 'line',
                        data: signalData
                    },
                    {
                        name: 'Histogram',
                        type: 'bar',
                        data: histogramData
                    },
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    width: [3, 3, 0, 3],
                    curve: 'smooth'
                },
                colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                plotOptions: {
                    bar: {
                        columnWidth: '80%'
                    }
                },
                fill: {
                    opacity: [1, 1, 0.8, 1]
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: 'MACD'
                        },
                        labels: {
                            formatter: function (value) {
                                return value.toFixed(3);
                            }
                        }
                    },
                    {
                        show: false,
                        seriesName: 'Signal'
                    },
                    {
                        show: false,
                        seriesName: 'Histogram'
                    },
                    {
                        opposite: true,
                        title: {
                            text: 'RSI'
                        },
                        min: 0,
                        max: 100,
                        seriesName: 'RSI',
                        labels: {
                            formatter: function (value) {
                                return value.toFixed(1);
                            }
                        }
                    }
                ],
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value, { seriesIndex }) {
                            if (seriesIndex === 0 || seriesIndex === 1 || seriesIndex === 2) {
                                return value.toFixed(3);
                            }
                            return value.toFixed(1);
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector("#indicators-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#indicators-chart').html('<div class="alert alert-danger">æŒ‡æ ‡å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // æ¸²æŸ“æˆäº¤é‡å›¾è¡¨
    function renderVolumeChart() {
        $('#volume-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const volumeData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.volume || 0)
            }));
            
            const volMaData = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.Volume_MA || 0)
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volumeData
                    },
                    {
                        name: 'å‡é‡çº¿',
                        type: 'line',
                        data: volMaData
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    width: [0, 3],
                    curve: 'smooth'
                },
                colors: ['#4e73df', '#1cc88a'],
                fill: {
                    opacity: [0.8, 1]
                },
                plotOptions: {
                    bar: {
                        columnWidth: '80%'
                    }
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(1) + 'K';
                            }
                            return value;
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value, { seriesIndex }) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(2) + ' ç™¾ä¸‡';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(2) + ' åƒ';
                            }
                            return value;
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector("#volume-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“æˆäº¤é‡å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#volume-chart').html('<div class="alert alert-danger">æˆäº¤é‡å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // å¯åŠ¨AIåˆ†æ
    function startAIAnalysis() {
        resetAIAnalysisUI();
        
        // å¯åŠ¨å¤„ç†æ—¶é—´è®¡æ—¶å™¨
        processingTime = 0;
        processingTimer = setInterval(function() {
            processingTime++;
            $('#ai-processing-time').text(processingTime);
            
            // æ›´æ–°è¿›åº¦æ¡ - åˆ›å»ºä¸€ä¸ªå‡çš„è¿›åº¦
            const progressPercent = Math.min(95, processingTime / 2);
            $('#ai-progress-bar').css('width', progressPercent + '%');
        }, 1000);
        
        // å¯åŠ¨AIåˆ†æä»»åŠ¡
        $.ajax({
            url: '/api/start_stock_analysis',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stock_code: stockCode,
                market_type: marketType
            }),
            success: function(response) {
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æœ
                if (response.status === 'completed' && response.result) {
                    // ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥å¤„ç†ç»“æœ
                    handleAIAnalysisResult(response.result);
                    return;
                }
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                pollAIAnalysisStatus(response.task_id);
            },
            error: function(xhr, status, error) {
                handleAIAnalysisError(xhr, status, error);
            }
        });
    }
    
    // è½®è¯¢AIåˆ†æçŠ¶æ€
    function pollAIAnalysisStatus(taskId) {
        // ä¿å­˜å½“å‰ä»»åŠ¡IDï¼Œç”¨äºå–æ¶ˆ
        window.currentAnalysisTaskId = taskId;
        
        function checkStatus() {
            $.ajax({
                url: `/api/analysis_status/${taskId}`,
                type: 'GET',
                success: function(response) {
                    // æ ¹æ®ä»»åŠ¡çŠ¶æ€å¤„ç†
                    if (response.status === 'completed') {
                        // åˆ†æå®Œæˆï¼Œåœæ­¢è½®è¯¢å’Œè®¡æ—¶å™¨
                        clearInterval(window.analysisStatusInterval);
                        
                        // å¤„ç†ç»“æœ
                        handleAIAnalysisResult(response.result);
                    } else if (response.status === 'failed') {
                        // åˆ†æå¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                        clearInterval(window.analysisStatusInterval);
                        
                        handleAIAnalysisError(null, 'failed', response.error || 'æœªçŸ¥é”™è¯¯');
                    } else {
                        // æ›´æ–°è¿›åº¦
                        const progress = response.progress || 0;
                        $('#ai-progress-bar').css('width', progress + '%');
                    }
                },
                error: function(xhr, status, error) {
                    console.log("è½®è¯¢çŠ¶æ€å‡ºé”™:", error);
                    // é”™è¯¯æ—¶ä»ç»§ç»­è½®è¯¢
                }
            });
        }
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        checkStatus();
        
        // è®¾ç½®è½®è¯¢é—´éš”
        window.analysisStatusInterval = setInterval(checkStatus, 2000);
    }
    
    // å¤„ç†AIåˆ†æç»“æœ
    function handleAIAnalysisResult(result) {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        
        // æ›´æ–°AIåˆ†æçŠ¶æ€
        $('#ai-analysis-status').text('åˆ†æå®Œæˆ').removeClass('bg-info bg-danger').addClass('bg-success');
        
        // æ¸²æŸ“AIåˆ†æå†…å®¹
        const aiAnalysis = result.ai_analysis || 'æ— æ³•è·å–AIåˆ†æç»“æœ';
        $('#ai-analysis').html(formatAIAnalysis(aiAnalysis));
        
        // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå†…å®¹
        $('#ai-analysis-loader').fadeOut(300, function() {
            $('#ai-analysis-content').css('opacity', '1');
        });

        // ä»AIåˆ†æç»“æœä¸­æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
        if (result.basic_info) {
            const stockName = result.basic_info.stock_name || $('#stock-title').text().split(' ')[0];
            const industry = result.basic_info.industry || $('#stock-info').text().split(' | ')[0];
            
            $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
            $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${$('#stock-info').text().split(' | ')[1]}`);
            $('#ai-analysis-stock-name').text(stockName);
        }
}
    
    // å¤„ç†AIåˆ†æé”™è¯¯
    function handleAIAnalysisError(xhr, status, error) {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        
        // æ›´æ–°AIåˆ†æçŠ¶æ€
        $('#ai-analysis-status').text('åˆ†æå¤±è´¥').removeClass('bg-info bg-success').addClass('bg-danger');
        
        // æ„å»ºé”™è¯¯æ¶ˆæ¯
        let errorMsg = 'åˆ†æè¿‡ç¨‹ä¸­å‡ºé”™';
        if (status === 'timeout') {
            errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œåˆ†æå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´';
        } else if (xhr && xhr.status === 524 || xhr && xhr.status === 504) {
            errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼ŒæœåŠ¡å™¨å¤„ç†æ—¶é—´è¿‡é•¿';
        } else if (xhr && xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg += ': ' + xhr.responseJSON.error;
        } else if (error) {
            errorMsg += ': ' + error;
        }
        
        // æ˜¾ç¤ºé”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').show();
        
        // éšè—åŠ è½½åŠ¨ç”»
        $('#ai-analysis-loader').hide();
    }
    
    // å–æ¶ˆAIåˆ†æ
    function cancelAnalysis() {
        if (window.currentAnalysisTaskId) {
            $.ajax({
                url: `/api/cancel_analysis/${window.currentAnalysisTaskId}`,
                type: 'POST',
                success: function(response) {
                    // åœæ­¢è®¡æ—¶å™¨
                    if (processingTimer) {
                        clearInterval(processingTimer);
                        processingTimer = null;
                    }
                    
                    // åœæ­¢è½®è¯¢
                    if (window.analysisStatusInterval) {
                        clearInterval(window.analysisStatusInterval);
                    }
                    
                    // æ›´æ–°UI
                    $('#ai-analysis-status').text('å·²å–æ¶ˆ').removeClass('bg-info bg-success').addClass('bg-warning');
                    $('#ai-analysis-loader').hide();
                    $('#ai-analysis').html('<div class="alert alert-warning">AIåˆ†æå·²å–æ¶ˆï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡è¯•åˆ†æ"æŒ‰é’®é‡æ–°å¼€å§‹åˆ†æã€‚</div>');
                    $('#ai-analysis-content').css('opacity', '1');
                    $('#error-retry').show();
                },
                error: function(error) {
                    console.error('å–æ¶ˆåˆ†æå¤±è´¥:', error);
                }
            });
        }
    }
    
    // é‡ç½®AIåˆ†æUI
    function resetAIAnalysisUI() {
        // åœæ­¢ç°æœ‰è®¡æ—¶å™¨å’Œè½®è¯¢
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        
        if (window.analysisStatusInterval) {
            clearInterval(window.analysisStatusInterval);
        }
        
        // é‡ç½®å¤„ç†æ—¶é—´
        processingTime = 0;
        $('#ai-processing-time').text('0');
        
        // é‡ç½®è¿›åº¦æ¡
        $('#ai-progress-bar').css('width', '0%');
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        $('#ai-analysis-status').text('æ­£åœ¨åˆ†æ...').removeClass('bg-success bg-danger bg-warning').addClass('bg-info');
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œéšè—å†…å®¹
        $('#ai-analysis-loader').show();
        $('#ai-analysis-content').css('opacity', '0');
        
        // éšè—é”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').hide();
    }
    
    // æ ¼å¼åŒ–AIåˆ†æ
    function formatAIAnalysis(text) {
    if (!text) return '';

    // å¯¹æ–‡æœ¬è¿›è¡ŒHTMLè½¬ä¹‰ï¼Œç¡®ä¿å®‰å…¨
    const safeText = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    // æ›¿æ¢ Markdown å…ƒç´ 
    let formatted = safeText
        // æ ‡é¢˜ - å¢åŠ å¯¹####å’Œ#####çš„æ”¯æŒ
        .replace(/^# (.*?)$/gm, '<h4 class="mt-3 mb-2">$1</h4>')
        .replace(/^## (.*?)$/gm, '<h5 class="mt-2 mb-2">$1</h5>')
        .replace(/^### (.*?)$/gm, '<h6 class="mt-2 mb-1">$1</h6>')
        .replace(/^#### (.*?)$/gm, '<h6 class="mt-2 mb-1">$1</h6>')
        .replace(/^##### (.*?)$/gm, '<div class="section-header bg-light p-2 rounded mb-2"><strong>$1</strong></div>')
        .replace(/^###### (.*?)$/gm, '<div class="subsection-header p-1 border-bottom mb-2"><strong>$1</strong></div>')
        
        // åŠ ç²—å’Œæ–œä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        
        // é¢œè‰²æ ‡è®°
        .replace(/\[\[ä¸Šæ¶¨\]\]/g, '<span class="trend-up"><i class="fas fa-arrow-up"></i> ä¸Šæ¶¨</span>')
        .replace(/\[\[ä¸‹è·Œ\]\]/g, '<span class="trend-down"><i class="fas fa-arrow-down"></i> ä¸‹è·Œ</span>')
        
        // åº”ç”¨ç‰¹æ®Šæ ·å¼åˆ°é‡‘èæœ¯è¯­
        .replace(/æ”¯æ’‘ä½/g, '<span class="keyword">æ”¯æ’‘ä½</span>')
        .replace(/å‹åŠ›ä½/g, '<span class="keyword">å‹åŠ›ä½</span>')
        .replace(/è¶‹åŠ¿/g, '<span class="keyword">è¶‹åŠ¿</span>')
        .replace(/å‡çº¿/g, '<span class="keyword">å‡çº¿</span>')
        .replace(/MACD/g, '<span class="term">MACD</span>')
        .replace(/RSI/g, '<span class="term">RSI</span>')
        .replace(/KDJ/g, '<span class="term">KDJ</span>')
        
        // çªå‡ºæ˜¾ç¤ºä»·æ ¼æ¨¡å¼å’Œå˜åŠ¨
        .replace(/\b(ä¸Šæ¶¨|å‡|æ¶¨)\b/g, '<span class="trend-up">$1</span>')
        .replace(/\b(ä¸‹è·Œ|é™|è·Œ)\b/g, '<span class="trend-down">$1</span>')
        .replace(/\b(ä¹°å…¥|åšå¤š|å¤šå¤´|çªç ´)\b/g, '<span class="trend-up">$1</span>')
        .replace(/\b(å–å‡º|åšç©º|ç©ºå¤´|è·Œç ´)\b/g, '<span class="trend-down">$1</span>')
        
        // çªå‡ºæ˜¾ç¤ºä»·æ ¼æ•°å€¼ (åŒ¹é…å¦‚ 31.25, 120.50)
        .replace(/(\d+\.\d{2})/g, '<span class="price">$1</span>')
        
        // å°†å¤šä¸ªæ¢è¡Œè½¬æ¢ä¸ºæ®µè½
        .replace(/\n\n+/g, '</p><p class="analysis-para">')
        .replace(/\n/g, '<br>');

    // åŒ…è£…åœ¨æ®µè½æ ‡ç­¾ä¸­ä»¥ä¿æŒä¸€è‡´çš„æ ·å¼
    return '<p class="analysis-para">' + formatted + '</p>';
}
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†é¢œè‰²ç±»
    function getScoreColorClass(score) {
        if (score >= 80) return 'bg-success';
        if (score >= 60) return 'bg-primary';
        if (score >= 40) return 'bg-warning text-dark';
        return 'bg-danger';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†é¢œè‰²
    function getScoreColor(score) {
        if (score >= 80) return '#28a745';
        if (score >= 60) return '#4e73df';
        if (score >= 40) return '#f6c23e';
        return '#e74a3b';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†æ¢¯åº¦é¢œè‰²
    function getScoreGradientColor(score) {
        if (score >= 80) return '#1cc88a';
        if (score >= 60) return '#36b9cc';
        if (score >= 40) return '#f6c23e';
        return '#e74a3b';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†æè¿°
    function getScoreDescription(score) {
        if (score >= 90) return 'å¼ºçƒˆæ¨è';
        if (score >= 80) return 'æ¨è';
        if (score >= 70) return 'æŒç»­å…³æ³¨';
        if (score >= 60) return 'å…³æ³¨';
        if (score >= 50) return 'è§‚æœ›';
        if (score >= 40) return 'ä¸­æ€§';
        if (score >= 30) return 'å‡æŒ';
        return 'å–å‡º';
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    function showError(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#alerts-container').html(alertHtml);
    }
    
    // æ˜¾ç¤ºä¿¡æ¯æç¤º
    function showInfo(message) {
        const alertHtml = `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#alerts-container').html(alertHtml);
    }
</script>
{% endblock %}